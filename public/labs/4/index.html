<!doctype html><html lang=en dir=ltr><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="
  Table of contents
  #

{: .no_toc .text-delta }

TOC
{:toc}



  Overview
  #

For this lab, we are going to dive into processes and systemd. We will do this by writing our own systemd service from scratch, while showing the benefits of running a service with systemd. This lab should be completed on your Linux VM.

  Part 0: Set up networking
  #

Before you start this lab, you&rsquo;ll need to make sure you can access services from your VM in your web browser!"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="http://localhost:1313/labs/4/"><meta property="og:site_name" content="Sysadmin DeCal"><meta property="og:title" content="Lab 4 - Processes and Services"><meta property="og:description" content="Table of contents # {: .no_toc .text-delta }
TOC {:toc} Overview # For this lab, we are going to dive into processes and systemd. We will do this by writing our own systemd service from scratch, while showing the benefits of running a service with systemd. This lab should be completed on your Linux VM.
Part 0: Set up networking # Before you start this lab, you’ll need to make sure you can access services from your VM in your web browser!"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="labs"><title>Lab 4 - Processes and Services | Sysadmin DeCal</title><link rel=icon href=/favicon.png><link rel=manifest href=/manifest.json><link rel=canonical href=http://localhost:1313/labs/4/><link rel=stylesheet href=/book.min.a66993900f9437bc8b9f3d67f5fea86cd8f2c5ca3eaecc1e818bb26d7ac89625.css integrity="sha256-pmmTkA+UN7yLnz1n9f6obNjyxco+rswegYuybXrIliU=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/en.search.min.28d1e126de307ffcd3a8254d9f1c14303f0918b2dfde22cc673bdc49855798da.js integrity="sha256-KNHhJt4wf/zTqCVNnxwUMD8JGLLf3iLMZzvcSYVXmNo=" crossorigin=anonymous></script><script defer src=/sw.min.6f6f90fcb8eb1c49ec389838e6b801d0de19430b8e516902f8d75c3c8bd98739.js integrity="sha256-b2+Q/LjrHEnsOJg45rgB0N4ZQwuOUWkC+NdcPIvZhzk=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>Sysadmin DeCal</span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script><ul><li><a href=/about/>About</a></li><li><input type=checkbox id=section-638171d5990482642c69d9e2d942b1e4 class=toggle>
<label for=section-638171d5990482642c69d9e2d942b1e4 class=flex><a role=button class=flex-auto>Announcements</a></label><ul><li><a href=/announcements/week-0/>Week 0 Announcement</a></li><li><a href=/announcements/week-1/>Week 1 Announcement</a></li></ul></li><li><input type=checkbox id=section-70822959fae8f27c0f79dc3a8400cebe class=toggle checked>
<label for=section-70822959fae8f27c0f79dc3a8400cebe class=flex><a role=button class=flex-auto>Labs</a></label><ul><li><a href=/labs/1/>Lab 1 - Unix, the Shell, OSS</a></li><li><a href=/labs/10/>Lab 10 - Puppet</a></li><li><a href=/labs/2/>Lab 2 - Core Shell & Shell Scripting</a></li><li><a href=/labs/3/>Lab 3 - Packages and Packaging</a></li><li><a href=/labs/4/ class=active>Lab 4 - Processes and Services</a></li><li><a href=/labs/5/>Lab 5 - Introduction to Networking</a></li><li><a href=/labs/6/>Lab 6 - Web Servers</a></li><li><a href=/labs/7/>Lab 7 - Security Fundamentals</a></li><li><a href=/labs/8/>Lab 8 - Version Control and Backups</a></li><li><a href=/labs/9/>Lab 9 - Containers (Docker)</a></li><li><a href=/labs/11/>Lab 11 - Kubernetes</a></li><li><a href=/labs/12/>Lab 12 - CUDA</a></li></ul></li><li><a href=/resources/>Resources</a></li></ul><ul><li><a href=https://github.com/alex-shpak/hugo-book target=_blank rel=noopener>Ed</a></li><li><a href=https://themes.gohugo.io/themes/hugo-book/ target=_blank rel=noopener>OCF</a></li><li><a href=https://themes.gohugo.io/themes/hugo-book/ target=_blank rel=noopener>Github</a></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label><h3>Lab 4 - Processes and Services</h3><label for=toc-control></label></div></header><article class="markdown book-article"><h2 id=table-of-contents>Table of contents
<a class=anchor href=#table-of-contents>#</a></h2><p>{: .no_toc .text-delta }</p><ol><li>TOC
{:toc}</li></ol><hr><h2 id=overview>Overview
<a class=anchor href=#overview>#</a></h2><p>For this lab, we are going to dive into processes and systemd. We will do this by writing our own systemd service from scratch, while showing the benefits of running a service with systemd. This lab should be completed on your Linux VM.</p><h2 id=part-0-set-up-networking>Part 0: Set up networking
<a class=anchor href=#part-0-set-up-networking>#</a></h2><p>Before you start this lab, you&rsquo;ll need to make sure you can access services from your VM in your web browser!</p><p>Our VMs support IPv6 only, so you will need to connect to the campus GlobalProtect VPN first if you don&rsquo;t have IPv6 connectivity.</p><h2 id=part-1-using-systemd>Part 1: Using systemd
<a class=anchor href=#part-1-using-systemd>#</a></h2><h3 id=what-services-are-running-right-now>What services are running right now?
<a class=anchor href=#what-services-are-running-right-now>#</a></h3><p>Run <code>systemctl</code>. You&rsquo;ll see a long table of every unit known to systemd.
Let&rsquo;s narrow it down to services for now. Run <code>systemctl --type=service</code>. Now you can see a list of all services running on your computer. Each of these services is a daemon running in the background. Do you see any familiar services running?</p><p><strong>Question 1:</strong> What is the name of a systemd service running on your system? What does it do? (If you&rsquo;re not sure what it does, Google it!)</p><h3 id=controlling-services>Controlling Services
<a class=anchor href=#controlling-services>#</a></h3><p>Now let&rsquo;s use <code>systemd</code> to control a an nginx web server. If you don&rsquo;t have it already, install nginx by issuing <code>sudo apt install nginx</code>. Once that is done we can tell systemd to start the service with the following: <code>sudo systemctl start nginx</code>. Run <code>systemctl status nginx</code> to ensure it is running.</p><blockquote><p>Note: If you already have a webserver running, you may need to
shut it down, so that port 80 is available for nginx to use.</p></blockquote><p>Now let&rsquo;s make nginx listen for connections on the nonstandard port 420. In <code>/etc/nginx/sites-available/default</code> change the following lines:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#66d9ef>listen</span> <span style=color:#ae81ff>80</span> <span style=color:#e6db74>default_server</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>listen</span> <span style=color:#e6db74>[::]:80</span> <span style=color:#e6db74>default_server</span>;
</span></span></code></pre></div><p>to:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#66d9ef>listen</span> <span style=color:#ae81ff>420</span> <span style=color:#e6db74>default_server</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>listen</span> <span style=color:#e6db74>[::]:420</span> <span style=color:#e6db74>default_server</span>;
</span></span></code></pre></div><blockquote><p>TIP: The first line configures the server to listen on <em>IPv4</em>, and
the second line configures <em>IPv6</em>.</p></blockquote><p>Tell systemd that nginx has changed configuration and needs reloading with: <code>sudo systemctl reload nginx</code>.</p><p>Now, accessing http://[yourusername].decal.ocfhosted.com:80 should now give you a connection refused error and your webserver will only be accessible via http://[yourusername].decal.ocfhosted.com:420.</p><p>Note that not all services can be reloaded; systemd will notify you if this is the case and such services will have to be restarted instead with: <code>sudo systemctl restart yourservice</code>.</p><p>Finally go ahead and stop the nginx service with <code>sudo systemctl stop nginx</code>.</p><p><strong>Question 2:</strong> What is the difference between <code>systemctl reload yourservice</code> and <code>systemctl restart yourservice</code>?</p><p><strong>Question 3:</strong> Upload a screenshot of your browser accessing the nginx webserver at http://[yourusername].decal.ocfhosted.com:420.
Note: If you can&rsquo;t access the IPv6 site use <code>curl localhost:420</code> on the VM and paste it&rsquo;s contents (it should be a html page).</p><h3 id=creating-a-service>Creating a service
<a class=anchor href=#creating-a-service>#</a></h3><p>Let&rsquo;s set up a web server and create a systemd unit for it. Make sure <code>git</code> is installed; if it&rsquo;s not, install it using <code>apt</code>.</p><p>If you don&rsquo;t already have the decal-labs repo from a past lab, run the following:</p><pre tabindex=0><code>$ git clone https://github.com/ocf/decal-labs
</code></pre><p>The materials for this part of the lab will be in the <code>decal-labs/4</code> directory.
We will also need to install some dependencies. Go ahead and execute the following commands:</p><pre tabindex=0><code># apt update
# apt install build-essential make python3-virtualenv
</code></pre><p>Now run <code>./run</code>. This should start up a simple web server at http://localhost:5000. Note that by default you can only access the web server on the VM itself.</p><p>Your mission, should you choose to accept it, is to write a systemd service that manages this web server. To do this, make a new unit file in <code>/etc/systemd/system/toy.service</code>. Refer to the slides for an example; DigitalOcean also has a
<a href=https://www.digitalocean.com/community/tutorials/understanding-systemd-units-and-unit-files>good guide</a> on how to write systemd units. Here is a skeleton; all you need to do is fill in the values for each field.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-systemd data-lang=systemd><span style=display:flex><span><span style=color:#66d9ef>[Unit]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Description</span><span style=color:#f92672>=</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Requires</span><span style=color:#f92672>=</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>After</span><span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[Install]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>WantedBy</span><span style=color:#f92672>=</span><span style=color:#e6db74>multi-user.target</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[Service]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStart</span><span style=color:#f92672>=</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>User</span><span style=color:#f92672>=</span>
</span></span></code></pre></div><p>Some questions worth considering while writing this unit file are:</p><ul><li>What units needs to be started before a webserver starts? (Hint: you can get a list of special &ldquo;target&rdquo; units using <code>systemctl --type=target</code>.)</li><li>What script should systemd run to start the webserver? (Remember you&rsquo;ll need to use the absolute path of the script, not the relative one. You can find this by running <code>realpath -se &lt;path to script></code>.)</li><li>Units run by root as default. Is that a safe practice for web servers?</li></ul><p>You are encouraged to experiment with other fields as suits your liking.
Once you have finished creating <code>toy.service</code>, let&rsquo;s start the service and have the it start whenever our machine is booted.</p><pre tabindex=0><code># systemctl start toy.service
# systemctl enable toy.service
</code></pre><h3 id=debugging>Debugging
<a class=anchor href=#debugging>#</a></h3><p>You can check if the unit file succeeded by running <code>systemctl status toy.service</code>. If you are having issues with the unit file or the web server, check the logs for this unit by running <code>journalctl -u toy.service</code>. If you run into errors don&rsquo;t get demoralized (it is, after all, only a decal); as a sysadmin you&rsquo;ll have to become comfortable making sense of arcane error messages.</p><blockquote><p>TIP: You can omit the <code>.service</code> in <code>systemctl</code> command for
speed. If the unit is another type (e.g. target, socket, or timer),
you must include the type. We include the <code>.service</code> for clarity.</p></blockquote><h3 id=crash-the-service>Crash the service!
<a class=anchor href=#crash-the-service>#</a></h3><p>One of the great benefits of using systemd to manage your services is that you don&rsquo;t have to worry unnecessarily about bringing a process back up if it crashes. So let&rsquo;s crash the service! You can do this by either sending a POST request with the json payload <code>{"crash":"true"}</code> to http://localhost:5000/crash on the VM (Hint: use <code>cURL</code>) or by killing the webserver manually by sending a signal &ndash; both will cause the unit to crash. You can verify if you succeeded by running <code>systemctl status toy.service</code>, and the unit should either be in an <code>inactive</code> or <code>failed</code> state, depending on how you killed it.</p><p><strong>Question 4:</strong> What command did you run to crash the service?</p><p>Now add the following the <code>/etc/systemd/system/toy.service</code> under the <code>Service</code> directive:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-systemd data-lang=systemd><span style=display:flex><span><span style=color:#a6e22e>Restart</span><span style=color:#f92672>=</span><span style=color:#e6db74>always</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>RestartSec</span><span style=color:#f92672>=</span><span style=color:#e6db74>10</span>
</span></span></code></pre></div><p>To tell systemd that the unit file has changed run <code>sudo systemctl daemon-reload</code>. Now start your webserver and crash it again in any way you please, and you should see that it come back online after 10 seconds! Note that you can also run <code>daemon-reload</code> and change a unit file while a service is running.</p><p><strong>Question 5:</strong> Upload your fully featured <code>toy.service</code> file to Gradescope.</p><h2 id=part-2-processes>Part 2: Processes
<a class=anchor href=#part-2-processes>#</a></h2><p><strong>There are no Gradescope questions to answer for this section, but you should still go through the steps to make sure you understand processes and how to use htop!</strong></p><p>Open up a terminal and run the <code>ps</code> command. You should see something like this:</p><pre tabindex=0><code>  PID TTY          TIME CMD
 3371 pts/2    00:00:00 zsh
 3416 pts/2    00:00:00 ps
</code></pre><p>Now open up <strong>another</strong> terminal and run <code>sleep 1000 &</code>, which start a sleeping process in the background. Then run <code>ps</code>. It should look like:</p><pre tabindex=0><code>~
❯ sleep 100 &amp;
[1] 3726

~
❯ ps
  PID TTY          TIME CMD
 3371 pts/2    00:00:00 zsh
 3726 pts/2    00:00:00 sleep
 3752 pts/2    00:00:00 ps
</code></pre><p>In the <strong>first</strong> terminal run <code>ps</code> again. You should notice that the <code>sleep</code> process is not showing up, even though the thousand seconds haven’t expired.</p><p>Why do you think this behavior occurs (hint: TTY column)?</p><p>We can get the process to display on the first terminal by running <code>ps -u</code>, which displays all the processes running as your user. Notice the PID column; each process has a unique ID assigned to it by the kernel. One thing we can do with this PID is send signals to the process. <code>sleep 1000</code> is pretty useless, so go ahead and kill it – <code>kill 3726</code> (substitute <code>3726</code> with whatever PID <code>ps</code> outputted for you).</p><p>The most common use of <code>ps</code> is to run <code>ps -ef</code> to see all the processes running on the system. Run <code>ps -e</code> and <code>ps -f</code> independently to see how the flags work together.</p><h3 id=htop>htop
<a class=anchor href=#htop>#</a></h3><p>Make sure <code>htop</code> is installed by running <code>sudo apt install htop</code>. Now, open up a terminal and run the <code>htop</code> command. <code>htop</code> can be thought of as a more extensive version of <code>ps -ef</code>, whereby process stats are updated in real-time.</p><p>First press <code>&lt;F2></code>, scroll down to Display options, and check “Hide userland process threads.” We won’t be dealing with those in this lab.</p><p>Now open up another terminal (or use <code>tmux</code>). Run the command <code>yes</code>. It uses a lot of resources as it prints a continuous stream of <code>y</code>’s.</p><p>What resource specifically does the <code>yes</code> command exhaust? If you are having trouble finding this, press <code>&lt;</code> to choose which resource to order processes by. Make sure to quit out of <code>yes</code> (^C) once you are finished.</p><h3 id=the-process-hierarchy>The process hierarchy
<a class=anchor href=#the-process-hierarchy>#</a></h3><p>Run <code>htop</code> once more. This time click <code>&lt;F5></code> to enter Tree View. You should see a visual representation of the process hierarchy on your system, with everything stemming from <code>/sbin/init</code> (systemd).</p><p>For curious students that are interested in seeing a more extensive process hierarchy on a large system, you are encouraged to run <code>htop</code> on the OCF server <code>tsunami</code>. Let us know of any cool processes that you find!</p><h3 id=orphan-processes>Orphan processes
<a class=anchor href=#orphan-processes>#</a></h3><p>Open a second terminal and <code>ssh</code> to your VM. Now run <code>sleep 1000 &</code>. You should see this new process pop into your <code>htop</code> session on your first terminal. If not, press <code>&lt;F3></code> and search for “sleep.” What is its parent?</p><p>Select this parent and press <code>&lt;F9></code> to kill it. Send the <code>SIGTERM</code> signal. The sleep process now has <code>init</code> as its new parent, which is PID 1. What you just did is manually orphan a process; when that happens said process is subsequently re-parented by the <code>init</code> process.</p><p>Now go through the same steps again. This time, send the parent a <code>SIGHUP</code> (hangup) signal. Can you still find the sleep process? When <code>SIGHUP</code> is sent to a parent shell, the parent subsequently sends hangup signals to any child processes before terminating; all processes that receive <code>SIGHUP</code> from a parent shell will terminate – this is one way to avoid creating orphan processes.</p><p>If you are interested in learning about the different signals, run <code>man 7 signal</code>. Note that you can run <code>man man</code> for an explanation about the different manual section numbers.</p><h2 id=exploration>Exploration
<a class=anchor href=#exploration>#</a></h2><p>Congratulations, you have completed the lab! This is just the tip of the iceberg when it comes to processes and services. If you want to learn more, here are some related topics you can look into.</p><ul><li><a href=https://en.wikipedia.org/wiki/Init>Wikipedia&rsquo;s article on init systems</a></li><li><a href=https://felipec.wordpress.com/2013/11/04/init/>The construction of a basic init system</a></li><li><a href=https://engineeringblog.yelp.com/2016/01/dumb-init-an-init-for-docker.html>Yelp&rsquo;s dumb-init, a lightweight init system for docker containers</a></li><li><a href=https://www.howtogeek.com/119815/htg-explains-what-is-a-zombie-process-on-linux/>Zombie Processes</a></li><li><a href=http://0pointer.de/blog/projects/socket-activated-containers.html>Socket activation</a></li><li>Systemd has been the source of a considerable amount of controversy.
<a href=http://without-systemd.org/wiki/index.php/Main_Page>Opponents</a> allege that it violates the Unix philosophy of “do one thing and do it well”, and that it has had too much scope creep, among other complaints.</li><li>Everything you wanted to know about Unix
<a href=https://www.win.tue.nl/~aeb/linux/lk/lk-10.html>threads, processes, process groups and sessions</a>. Bear in mind that this document is a little dated when it comes to the code about threads, and its description of what happens when a pseudotty is closed is not actually correct.</li></ul><h2 id=submission>Submission
<a class=anchor href=#submission>#</a></h2><p>Go to Gradescope to submit your answers!</p></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><div class="flex flex-wrap justify-between"><span><a href=/labs/3/ class="flex align-center book-icon"><img src=/svg/backward.svg class=book-icon alt=Previous title="Lab 3 - Packages and Packaging">
<span>Lab 3 - Packages and Packaging</span>
</a></span><span><a href=/labs/5/ class="flex align-center book-icon"><span>Lab 5 - Introduction to Networking</span>
<img src=/svg/forward.svg class=book-icon alt=Next title="Lab 5 - Introduction to Networking"></a></span></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div></main></body></html>